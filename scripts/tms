#!/bin/bash

# Function to set terminal title with remote connection emoji
set_title() {
    printf '\033]0;ðŸ”— %s\007' "$1"
}

# If session name provided as argument, use it directly
if [ -n "$1" ]; then
    session_name="$1"
    set_title "m3pro:$session_name"
    ssh -t m3pro "tmux attach -t '$session_name' || tmux new -s '$session_name'"
    exit 0
fi

# Get existing sessions
sessions=$(ssh m3pro "tmux list-sessions -F '#S' 2>/dev/null" | sort)

if [ -z "$sessions" ]; then
    echo "No tmux sessions found. Creating new session..."
    read -p "Session name: " session_name
    set_title "m3pro:$session_name"
    ssh -t m3pro "tmux new -s '$session_name'"
    exit 0
fi

# Check if fzf is available
if command -v fzf >/dev/null 2>&1; then
    # Use fzf for selection
    echo "Select a session (or type new name):"
    choice=$(echo -e "â”€â”€ Create new session â”€â”€\n$sessions" | fzf --height=~50% --prompt="tmux> " --header="â†‘/â†“ to navigate, Enter to select, Esc to cancel")
    
    if [ -z "$choice" ]; then
        echo "Cancelled."
        exit 0
    elif [ "$choice" = "â”€â”€ Create new session â”€â”€" ]; then
        read -p "New session name: " session_name
        set_title "m3pro:$session_name"
        ssh -t m3pro "tmux new -s '$session_name'"
    else
        set_title "m3pro:$choice"
        ssh -t m3pro "tmux attach -t '$choice'"
    fi
else
    # Fall back to numbered selection
    echo "Available sessions:"
    echo "$sessions" | nl
    echo "0) Create new session"
    read -p "Choose session (or enter name): " choice
    
    if [[ "$choice" =~ ^[0-9]+$ ]]; then
        if [ "$choice" -eq 0 ]; then
            read -p "New session name: " session_name
            set_title "m3pro:$session_name"
            ssh -t m3pro "tmux new -s '$session_name'"
        else
            session_name=$(echo "$sessions" | sed -n "${choice}p")
            set_title "m3pro:$session_name"
            ssh -t m3pro "tmux attach -t '$session_name'"
        fi
    else
        set_title "m3pro:$choice"
        ssh -t m3pro "tmux attach -t '$choice' || tmux new -s '$choice'"
    fi
fi
