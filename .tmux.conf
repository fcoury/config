# =============================================================================
# tmux configuration
#
# Symlinked from this repo to ~/.tmux.conf by setup.sh.
# Prefix is Ctrl+S (not the default Ctrl+B).
#
# Helper scripts:
#   fish/conf.d/tmux.fish  - shell functions (tm, tp, tv, tn, zm)
#   scripts/tms            - remote tmux session manager over SSH
# =============================================================================

# --- Shell & terminal setup ---
set-option -g default-shell /opt/homebrew/bin/fish
set-option -g default-terminal "tmux-256color"
set-option -g terminal-overrides ",xterm-256color:Tc"  # enable true color
set-option -g renumber-windows on    # reorder window numbers when one is closed
set-option -g history-limit 100000   # generous scrollback buffer

# --- Core behavior ---
unbind r
bind g source-file ~/.tmux.conf      # prefix + g to reload this config

set -sg escape-time 0  # no delay after pressing Escape (critical for neovim)
set -g base-index 1    # number windows starting from 1, not 0
set -g prefix C-s      # remap prefix from Ctrl+B to Ctrl+S
set -g mouse on        # enable mouse for scrolling, pane selection, resizing
setw -g mode-keys vi   # use vim keybindings in copy mode

# restore last environment automatically (disabled â€” can be slow)
# set -g @continuum-restore 'on'

# --- Pane title bars (set by dmux, kept here for easy tweaking) ---
set -g pane-border-status top
set -g pane-border-format "#{?pane_active,#[reverse],} #{pane_title} #[default]"

# --- Plugin settings ---

# sessionx: fuzzy session switcher (prefix + o)
set -g @sessionx-bind 'o'

# --- Pane navigation (vim-style with prefix) ---
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# --- Clear screen (Alt+k) ---
# If a program (not a shell) is running in the pane, send Ctrl+L instead.
# Otherwise, clear the screen and scrollback like macOS Cmd+K.
is_program="ps -o comm= -t '#{pane_tty}' | grep -vE '^-?(fish|bash|zsh|sh|ps|grep|awk|sed|cut|sort|uniq|head|cat|echo|printf)$' | grep -q ."
bind -n M-k if-shell "$is_program" 'send-keys -R; clear-history' 'send-keys C-l'

# --- Pane resizing (vim-style, repeatable with prefix) ---
bind-key -r H resize-pane -L 5
bind-key -r J resize-pane -D 5
bind-key -r K resize-pane -U 5
bind-key -r L resize-pane -R 5

# --- Pane zoom ---
bind-key z resize-pane -Z  # toggle fullscreen for the active pane

# --- Edit scrollback in neovim ---
bind-key e run-shell "fish -c tmux-edit"

# --- Pane splitting (open in the same directory) ---
bind d split-window -h -c '#{pane_current_path}'  # horizontal split
bind s split-window -v -c '#{pane_current_path}'  # vertical split

# --- Pane management ---
bind-key i join-pane -s !  # pull the last pane back into this window
bind-key - detach          # quick detach
bind x kill-pane           # close the active pane without confirmation

# --- Clipboard integration ---
set -g set-clipboard on
set -g allow-passthrough on                   # let apps (e.g. OSC 52) write to clipboard
set -as terminal-features ',xterm*:clipboard'

# Copy mode: v to start selection, y and Enter to copy
# bind-key -T copy-mode-vi y send -X copy-selection-and-cancel
# bind-key -T copy-mode-vi Enter send -X copy-selection-and-cancel
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-selection
bind-key -T copy-mode-vi Enter send -X copy-selection
# Prevent tmux from exiting copy-mode after dragging with the mouse
unbind-key -T copy-mode-vi MouseDragEnd1Pane

# --- Plugins (managed by TPM) ---
set -g @plugin 'tmux-plugins/tpm'             # plugin manager
set -g @plugin 'omerxx/tmux-sessionx'         # fuzzy session switcher
set -g @plugin 'tmux-plugins/tmux-resurrect'  # save/restore sessions across restarts
set -g @plugin 'tmux-plugins/tmux-continuum'  # auto-save sessions periodically
# set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'roosta/tmux-fuzzback'         # fzf search through scrollback
set -g @plugin 'wfxr/tmux-fzf-url'           # fzf pick URLs from scrollback
# set -g @plugin 'tmux-plugins/tmux-urlview'
# set -g @plugin 'nhdaly/tmux-better-mouse-mode'
# set -g @plugin 'hendrikmi/tmux-cpu-mem-monitor'

# fuzzback: search scrollback in a popup with fzf
set -g @fuzzback-popup 1
set -g @fuzzback-hide-preview 1
set -g @fuzzback-popup-size '60%'

# --- Theme ---
# Dracula theme (disabled)
# set -g @plugin 'dracula/tmux'
# set -g @dracula-show-powerline true
# set -g @dracula-fixed-location "Aventura, FL"
# set -g @dracula-plugins "wather"
# set -g @dracula-show-flags true
# set -g @dracula-show-left-icon session
# set -g status-position top

# Nord theme (disabled)
# source-file ~/.config/tmux/nord-theme.conf
source-file ~/.config/tmux/lackluster.conf
# source-file ~/.config/tmux/rose-pine.conf
# source-file ~/.config/tmux/catppuccin.conf

# --- Initialize TPM (must be the last line before overrides) ---
run '~/.tmux/plugins/tpm/tpm'

# --- Overrides (after TPM so plugins don't clobber them) ---
# Press prefix twice (Ctrl+S Ctrl+S) to send a literal Ctrl+S to the app
bind C-s send-prefix
